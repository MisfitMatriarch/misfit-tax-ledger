<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Misfit Tax Ledger</title>
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body{margin:0;background:#0a0d12;color:white;font-family:'EB Garamond',serif}
.container{max-width:720px;margin:auto;padding:40px}
h1{font-size:42px;margin-bottom:12px}
button{padding:12px 24px;border:1px solid #7B6BA1;background:none;color:white;cursor:pointer}
.domain{margin-bottom:20px}
.result-card{margin-top:30px;padding:20px;border:1px solid #333;border-radius:8px}
</style>
</head>
<body>
<div class="container" id="app"></div>

<script>
const domains = {
  energy:["Q1","Q2","Q3","Q4","Q5","Q6"],
  recovery:["Q7","Q8","Q9","Q10","Q11","Q12","Q13","Q14"],
  signals:["Q15","Q16","Q17","Q18","Q19","Q20"],
  masking:["Q21","Q22","Q23","Q24","Q25","Q26"],
  environment:["Q27","Q28","Q29","Q30","Q31","Q32"],
  carryover:["Q33","Q34","Q35","Q36","Q37","Q38"],
  sustainability:["Q39","Q40","Q41","Q42","Q43","Q44"]
};

let answers={};

function scoreDomain(ids){
  const vals=ids.map(id=>answers[id]).filter(v=>v!==undefined);
  if(!vals.length) return null;
  return Math.round((vals.reduce((a,b)=>a+b,0)/vals.length)/4*100);
}

function calculateResults(){
  const domainScores={};
  Object.keys(domains).forEach(d=>{
    domainScores[d]=scoreDomain(domains[d]);
  });

  const attribution={
    personal:avg([domainScores.energy,domainScores.recovery,domainScores.signals,domainScores.masking,domainScores.carryover,domainScores.sustainability]),
    interactional:avg([domainScores.masking,domainScores.environment,domainScores.energy]),
    structural:avg([domainScores.environment,domainScores.recovery,domainScores.carryover])
  };

  const ranked=Object.entries(attribution).sort((a,b)=>b[1]-a[1]);
  const delta=ranked[0][1]-ranked[1][1];

  let state="clean";
  if(delta<=8) state="mixed";
  else if(delta<=15) state="primary_secondary";

  return{
    domainScores,
    attribution,
    driverState:{state,primary:ranked[0][0],secondary:ranked[1][0],delta}
  };
}

function avg(arr){
  const v=arr.filter(x=>x!==null&&x!==undefined);
  if(!v.length) return null;
  return Math.round(v.reduce((a,b)=>a+b,0)/v.length);
}

function render(){
  const app=document.getElementById("app");
  app.innerHTML="";

  const h=document.createElement("h1");
  h.textContent="The Misfit Tax Ledger";
  app.appendChild(h);

  Object.keys(domains).forEach(d=>{
    const div=document.createElement("div");
    div.className="domain";
    div.innerHTML="<strong>"+d+"</strong>";
    domains[d].forEach(q=>{
      const input=document.createElement("input");
      input.type="range";
      input.min=0;
      input.max=4;
      input.onchange=e=>answers[q]=parseInt(e.target.value);
      div.appendChild(input);
    });
    app.appendChild(div);
  });

  const btn=document.createElement("button");
  btn.textContent="See Results";
  btn.onclick=()=>{
    const r=calculateResults();
    const card=document.createElement("div");
    card.className="result-card";
    card.innerHTML="<h3>Primary Driver: "+r.driverState.primary+"</h3>"+
                   "<p>State: "+r.driverState.state+"</p>";
    app.appendChild(card);
  };
  app.appendChild(btn);
}

render();
</script>
</body>
</html>
